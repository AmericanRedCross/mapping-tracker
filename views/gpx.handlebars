<link rel="stylesheet" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<link rel="stylesheet" href="//cdn.datatables.net/1.10.10/css/jquery.dataTables.css" />
<style>
.btn-file {
    position: relative;
    overflow: hidden;
}
.btn-file input[type=file] {
    position: absolute;
    top: 0;
    right: 0;
    min-width: 100%;
    min-height: 100%;
    font-size: 100px;
    text-align: right;
    filter: alpha(opacity=0);
    opacity: 0;
    outline: none;
    background: white;
    cursor: inherit;
    display: block;
}
#map{
  height: 450px;
}
.leaflet-control-attribution a {
  color: #6d6e70 !important;
  cursor: pointer;
}
</style>


<header class="row header">
	<div class="col-md-12">
		<h1>GPX track manager</h1>
	</div>
</header>

<form id="uploadForm" enctype="multipart/form-data" action="uploadgpx" method="post">
  <div class="input-group">
      <span class="input-group-btn">
          <span id="uploadBtn" class="btn btn-dark btn-file">
              Upload &nbsp;<i class="fa fa-plus"></i> <input type="file" name="gpxFiles" accept=".gpx" multiple />
					</span>
					<!-- <span class="btn btn-dark btn-file disabled">
							Upload &nbsp;<i class="fa fa-spinner fa-pulse"></i> <input type="file" name="userPhoto" multiple />
          </span> -->
      </span>
  </div>
	<span class="help-block">
		Files must be .gpx files. File should be name with the following convention: buifbguisb
	</span>
<!-- <input type="submit" value="Upload Image" name="submit"> -->
<!-- <input type='text' id='random' name='random'><br> -->
  <span id = "status"></span>
</form>


<hr>

<div class="row">
<div class="col-md-6">
<div id="map"></div>
</div>
<div class="col-md-6">
  <div id="files-table">

  </div>
</div>
</div>

<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
<script src="//cdn.datatables.net/1.10.10/js/jquery.dataTables.js"></script>

  <script>
  $(document).ready(function() {
    $('#uploadForm').submit(function() {

      d3.select("#uploadBtn").classed("disabled", true);
      d3.select("#uploadBtn i").classed({'fa-plus':false, 'fa-spinner':true, 'fa-pulse':true});

      $(this).ajaxSubmit({
        error: function(xhr) {
          status('Error: ' + xhr.status);
        },
        success: function(response) {
          console.log(response)
          //$("#status").empty().text(response);
          d3.select("#uploadBtn").classed("disabled", false);
          d3.select("#uploadBtn i").classed({'fa-plus':true, 'fa-spinner':false, 'fa-pulse':false});
          getDbFiles();
        }
      });
      return false;
    });

    $('.btn-file :file').on('fileselect', function(event, numFiles, label) {
        // console.log(numFiles);
        // console.log(label);
    });

});

$(document).on('change', '.btn-file :file', function() {
    var input = $(this),
        numFiles = input.get(0).files ? input.get(0).files.length : 1,
        label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
    input.trigger('fileselect', [numFiles, label]);
    $('#uploadForm').submit();
});



var map = L.map('map').setView([0, 0], 2);
var mapFeatures = L.layerGroup().addTo(map);

L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
  attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors | ' + '<a class="dislaimer" onclick="$(' + "'#info-modal'" + ').modal();"><span class="glyphicon glyphicon-info-sign"></span> disclaimer</a>'
}).addTo(map);


function getDbFiles(){

  $.ajax({
    type: 'GET',
    url: '/query/distinct-file',
    dataType: 'JSON'
  }).done(function(response){
    populateTable(response);
  });

  // url = window.location.origin + "/query/distinct-file";
  // $.get(url, function(response){
  //   populateTable(response);
  // });
}

function populateTable(rows){

  $("#files-table").empty();
  $("#files-table").html('<table id="dataTable"><thead><tr><th>file name</th><th>view</th><th>delete</th></tr></thead><tbody></tbody></table>');
  $.each(rows, function(i,d){
    var rowHtml = "<tr><td>" + d.file + "</td>" +
    '<td><i class="fa fa-globe" onclick="getGpxGeoJson(' + "'" + d.file + "'" + ')"></i></td>' +
    '<td><i class="fa fa-trash" onclick="removeFromDb(' + "'" + d.file + "'" + ')"></i></td></tr>';
    $('#dataTable tbody').append(rowHtml);
  })
  $('#dataTable').DataTable();

}

getDbFiles();

function removeFromDb(filename){

  var confirmation = confirm('Are you sure you want to delete this file and all associated track segmenets?');
  if (confirmation === true) {
    $.ajax({
      type: 'POST',
      data: {'file': filename},
      url: '/query/remove-file'
    }).done(function(){
      mapFeatures.clearLayers();
      getDbFiles();
    });
  } else {
    return false;
  }

}


function getGpxGeoJson(filename){
  $.ajax({
    type: 'POST',
    data: {'file': filename},
    url: '/query/gpx-single',
    dataType: 'JSON'
  }).done(function(response){
    mapData(response);
  });
}

function mapData(data){
  mapFeatures.clearLayers();
  var lineLayer = L.geoJson(data, {
    style: function(feature){
			return {
	        "weight": 5,
					"color": (feature.properties.speed === 'walk') ? "#0047d3" : "#ed1b2e",
					"stroke": (feature.properties.speed === 'walk') ? "#0047d3" : "#ed1b2e",
	        "opacity": 0.65,
	        "clickable": false
	    }
		}
  }).addTo(mapFeatures)
  map.fitBounds(lineLayer.getBounds());
}

</script>
